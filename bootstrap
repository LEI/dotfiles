#!/bin/bash
#
# Bootstrap dotfiles
# Mainly inspired from mathiasbynens/dotfiles and holman/dotfiles

# Set working directory
cd "$(dirname "$0")"

DOTFILES_DIR=$(pwd)
TARGET_DIR=$HOME
indent_level=1
indent_size=3

export DOTFILES=$DOTFILES_DIR
export lib=$DOTFILES_DIR/lib

# Get command
args=("$@")

set -e

# Print command line usage
echo_usage () {
	$lib/usage
	exit 0
}

echo_debug () {
	if [ "$debug" = true ]; then
		info "Symbolic dry run" "Changes are not applied while debugging" true
	fi
}

do_setup () {
	# TODO Configuration file
	# if [ -e "$DOTFILES_DIR/config" ]
	# then
	# 	source $DOTFILES_DIR/config
	# else
	# 	echo "$cfg file needed. See config.sample for directions and copy it to config."
	# 	exit 1
	# fi
	# Ignore lists
	global_ignore=(".DS_Store" ".gitignore" "README.md" ".git" "gitconfig.sample")
	vim_ignore=(${global_ignore[@]} "vimrc." "gvimrc.")

	echo 'bootfiles dotstrap'

	#git pull origin master

	# Import functions
	source $lib/print
	source $lib/ask
	source $lib/dir
	source $lib/link
	source $lib/git
	source $lib/brew
}

do_gitconfig () {
	# Create git/.gitconfig if needed
	local gitconfig_file="git/gitconfig."
	if check_file "$gitconfig_file" Y; then
		if ask "Configure git credentials ?" Y; then
			gitconfig
		else
			skipped
		fi
	else
		warn "Git configuration already file exists" "$gitconfg_file"
	fi
}

do_link () {
	if ask "Create symbolic links ?" Y true; then
		echo_debug
		dir "" link_dotfile ${global_ignore[@]} || skipped
		dir "bin" link_file || skipped
		# COPY dir ".vim" link_file ${vim_ignore[@]} || skipped
		echo ''
		success "Stuff linked."
	else
		skipped "symlinks"
	fi
}

undo_link () {
	if ask "Erase symbolic links ?" Y true; then
		echo_debug
		dir "" unlink_dotfile ${global_ignore[@]} || skipped
		echo ''
		success "Symlinks unchained."
	else
		skipped "symlinks"
	fi


	# Remove bin/* and */*.symlink
	# ask "Remove symbolic links ?" Y && \
	# 	info "Unlinking bin files" "..." && \
	# 	dir "/bin" "" unlink && \
	# 	info "Unlinking dotfiles" "..." && \
	# 	dir "/" "*.symlink" unsymlink && \
	# 	success 'Symlinks unchained.' || \
	# 	skip

	# Remove .vim
	# TODO Symlink
	# ask "Remove .vim directory ?" Y && \
	# 	remove ".vim" || \
	# 	skip
}

do_copy () {
	if ask "Copy directoriz ?" Y true; then
		echo_debug
		# TODO ${vim_ignore[@]} || lib/exclude
		copy ".vim" || skipped
		copy ".atom" || skipped
		echo ''
		success "Stuff copied."
	else
		skipped "directoriz"
	fi
}

undo_copy () {
	if ask "Remove directoriz ?" Y true; then
		echo_debug
		# TODO ${vim_ignore[@]} || lib/exclude
		remove ".vim" || skipped
		remove ".atom" || skipped
		echo ''
		success "Stuff removed."
	else
		skipped "directoriz"
	fi
}

do_defaults () {
	if ask "Set defaults ?" Y true; then
		local defaults=$DOTFILES_DIR/lib/defaults
		source_file $defaults || \
			warn "Configuration didn't fully complete" "lib/defaults"
		# success "Defaults loaded" "lib/defaults"
		indent_level=1
		success "OS configuration done."
	else
		skipped "defaults"
	fi
}

copy () {
	local src=$1

	((indent_level++))
	if [ -f "$src" -o -d "$src" ] && \
		. $lib/copy $src $TARGET_DIR > /dev/null; then
		success "$src" "Copied to ~/$src"
	else
		fail "$src" "Failed to be copied"
	fi
	((indent_level--))
}

remove () {
	local src=$1

	((indent_level++))
	if [ -f "$src" -o -d "$src" -o -L "$src" ] && \
		rm -r $TARGET_DIR/$src 2> /dev/null; then
		success "Removed" "$src"
	else
		fail "$src" "Can't be removed"
	fi
	((indent_level--))
}

check_file () {
	local file=$1

	if [ -f $file ]; then
		return 1
	else
		return 0
	fi
}

source_file () {
	local file=$1

	if [ -f $file ] && source "$file"; then
		#success "Operation successfull !"
		return 1
	else
		#fail "Command failed !"
		return 0
	fi
}

sandbox () {
	TARGET_DIR=$TARGET_DIR/sandbox
	info "$TARGET_DIR" "Using sandbox folder"

	if [ ! -d $TARGET_DIR ]; then
		mkdir $TARGET_DIR
	fi
}

install () {
	echo ''

	# Git
	#####

	do_gitconfig

	echo ''; indent_level=1

	# Symbolic links
	################

	do_link

	echo ''; indent_level=1

	# Directories
	################

	do_copy

	echo ''; indent_level=1

	# Set OS defaults
	#################

	do_defaults
}

uninstall () {
	echo ''

	# Does not undo bundles & defaults

	# undo_link

	undo_copy

	end_message="Bootstrap uninstalled things."
}

# Parse arguments and unset recognized ones
parse_flags () {
	local args=("$@")

	for (( i = ${#args[@]} - 1; i >= 0; i-- )); do
		case ${args[i]} in
			-d|--debug)
				debug=true
				unset args[i] ;;
			# -?|--default)
			# 	force_default=true
			# 	unset args[i] ;;
			# -f|--force)
			# 	force=true
			# 	unset args[i] ;;
			-m|--mute)
				mute=true
				unset args[i] ;;
			-s|--sandbox)
				sandbox
				unset args[i] ;;
			-h|--help)
				echo_usage
				unset args[i] ;;
			-*) echo "Unknown option: ${args[i]}"
				echo_usage
				unset args[i] ;;
		esac
	done

	# Print echo_usage if > 1 argument left
	[ ${#args[@]} -gt 1 ] && echo_usage

	echo ${args[@]}
}

# Execute command
bootstrap () {
	cmd=$(parse_flags $@)

	case $cmd in
		'')          install ;;
		'install')   install ;;
		'uninstall') uninstall ;;
		'link')      do_link ;;
		'copy')      do_copy ;;
		'defaults')  do_defaults ;;
		'bundle')    exec "set-up" ;;
		*)           echo_usage ;;
	esac
}

do_setup
bootstrap ${args[@]}

echo ''
indent_level=0

[ -n "$end_message" ] || end_message="Things were bootstrapped !"
success "$end_message" " "

# source ~/.bash_profile || \
# 	fail "~/.bash_profile"
