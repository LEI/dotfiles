{{- $_ := . | setValueAtPath "client" "opencode" -}}
{{- $mcp := includeTemplate "mcp.jsonc" . | fromJsonc -}}
{{- $mcpServers := includeTemplate "dot_config/opencode/.mcp.json.tmpl" . | fromJson -}}

{{- $ohMyOC := false -}}
{{- $quotaToast := false -}}
{
  "$schema": "https://opencode.ai/config.json",
  "theme": {{ get . "theme" | default "system" | quote }},
  // "model": "anthropic/claude-sonnet-4-5",
  {{- if and (eq .osIDLike "darwin") (eq .chezmoi.arch "arm64") }}
  // "model": "mlx-community/Llama-3.2-3B-Instruct-4bit",
  {{- end }}
  "autoupdate": false,

  // https://github.com/anomalyco/opencode/pull/8562
  // "server": {
  //   "hostname": "localhost"
  // },

  // https://opencode.ai/docs/rules/#using-opencodejson
  "instructions": [
    // ".cursor/rules/*.md",
    "CONTRIBUTING.md",
    // "docs/development-standards.md",
    // "docs/guidelines.md",
    "packages/*/AGENTS.md"
    // "test/testing-guidelines.md",
  ],
  "plugin": [
    "@franlol/opencode-md-table-formatter@0.0.3",
    // "@ramtinj95/opencode-tokenscope@1.5.2",
    {{- if $quotaToast }}
    "@slkiser/opencode-quota@1.4.0",
    {{- end }}
    "opencode-pty@0.2.0",
    // "opencode-sessions@1.0.0",
    {{- if $ohMyOC }}
    // bunx oh-my-opencode install --no-tui --claude=no --gemini=yes --copilot=yes
    // mv ~/.config/opencode/oh-my-opencode.json{,c}
    "oh-my-opencode@3.2.3",
    {{- else }}
    "@mohak34/opencode-notifier@0.1.15",
    {{- end }}
    "opencode-antigravity-auth@1.4.5"
  ],
  {{- if $quotaToast }}
  "experimental": {
    "quotaToast": {
      "enabledProviders": [
        "copilot"
        // "openai",
        // "google-antigravity",
      ]
    }
  },
  {{- end }}
  // https://opencode.ai/docs/permissions#defaults
  "permission": {
    "*": "ask",
    // Reading a file (matches the file path)
    "read": {
      "*": "allow",
      "*.env": "deny",
      "*.env.*": "deny",
      "*.env.example": "allow"
    },
    // All file modifications (covers edit, write, patch, multiedit)
    "edit": "ask",
    // File globbing (matches the glob pattern)
    "glob": "allow",
    // Content search (matches the regex pattern)
    "grep": "allow",
    // Listing files in a directory (matches the directory path)
    "list": "allow",
    // Running shell commands (matches parsed commands like git status --porcelain)
    "bash": {
      "*": "ask",
      "awk *": "allow",
      "cat *": "allow",
      // "cd *": "allow",
      // "curl *": "allow",
      "echo *": "allow",
      "env *": "deny",
      "fd *": "allow",
      "find *": "allow",
      // "git *": "deny",
      // "git worktree *": "allow",
      // "git wt *": "allow",
      "grep *": "deny",
      "head *": "allow",
      "jq *": "allow",
      "ls *": "deny",
      // "mv *": "deny",
      "rg *": "allow",
      "rm *": "deny",
      "sed *": "allow",
      "sed * -I*": "ask",
      "sed * -i*": "ask",
      "sleep *": "allow",
      "tail *": "allow",
      "test *": "allow",
      "trash *": "ask",
      "wc *": "allow",
      "yq *": "allow",

      "npm run build*": "allow",
      "npm run dev*": "allow", // Requires timeout or pty_spawn
      "npm run test*": "allow",
      "npm test *": "allow",
      "npm t *": "allow",

      "npx skills check *": "allow",
      "npx skills find *": "allow",
      "npx skills list *": "allow",
      "npx skills search *": "allow",

      "sq *": "allow",
      "sq * -o*": "ask",
      "sq * --output*": "ask"
    },
    // Launching subagents (matches the subagent type)
    // "task": "ask",
    "task": {
      "*": "deny",
      // "orchestrator-*": "allow",
      // "code-reviewer": "ask"
    },
    // Loading a skill (matches skill name, not org/name)
    "skill": {
      "*": "ask",
      // affaan-m
      "backend-patterns": "allow",
      "coding-standards": "allow",
      "security-review": "allow",
      "tdd-workflow": "allow",
      // anthropics
      "mcp-builder": "allow",
      "skill-creator": "allow",
      // antfu
      "pnpm": "allow",
      "turborepo": "allow",
      // github
      "git-commit": "deny",
      // local
      "flux-operator": "deny",
      "sq": "allow",
      // supabase
      "supabase-postgres-best-practices": "allow",
      // superpowers
      "brainstorming": "allow",
      "dispatching-parallel-agents": "allow",
      "executing-plans": "allow",
      "finishing-a-development-branch": "allow",
      "receiving-code-review": "allow",
      "requesting-code-review": "allow",
      "subagent-driven-development": "allow",
      "systematic-debugging": "allow",
      "test-driven-development": "allow",
      "using-git-worktrees": "allow",
      "using-superpowers": "allow",
      "verification-before-completion": "allow",
      "writing-plans": "allow",
      "writing-skills": "allow",
      // vercel
      "ai-sdk": "allow",
      // vercel-labs
      "find-skills": "allow",
      "next-best-practices": "allow",
      "vercel-react-best-practices": "allow",
      "web-design-guidelines": "allow",
      // wshobson
      "api-design-principles": "allow",
      "code-review-excellence": "allow",
      "nodejs-backend-patterns": "allow",
      "typescript-advanced-types": "allow"
    },
    // Running LSP queries (currently non-granular)
    // OPENCODE_EXPERIMENTAL_LSP_TOOL=true or OPENCODE_EXPERIMENTAL=true
    "lsp": "allow",
    // Reading/updating the todo list
    "todoread": "deny",
    "todowrite": "deny",
    // Fetching a URL (matches the URL)
    // "webfetch": { "*" "ask" },
    // Web/code search (matches the query)
    "websearch": "allow",
    "codesearch": "allow",
    // Triggered when a tool touches paths outside the project working directory
    "external_directory": "ask",
    // Triggered when the same tool call repeats 3 times with identical input
    // "doom_loop": "ask",
    // Ask the user questions during execution
    "question": "allow",

    // Custom tools
    "notify": "allow",

    // MCP tools
    {{- range $mcp.servers | keys | sortAlpha }}
    "{{ . }}_*": "deny",
    {{- end }}

    "mcp-registry_*": "allow",
    "skills-search_*": "allow",

    // https://github.com/modelcontextprotocol/servers/tree/main/src/git
    "git_git_*": "ask",
    "git_git_branch": "allow",
    "git_git_diff*": "allow",
    "git_git_log": "allow",
    "git_git_show": "allow",
    "git_git_status": "allow",

    // Plugins
    "pty_*": "allow",
    "pty_kill": "ask",
    "pty_spawn": "ask",
    "pty_write": "ask",

    // Included in opencode
    "context7_*": "allow",
    // "context7_query-docs": "allow",
    // "context7_resolve-library-id": "allow",
    "exa_*": "ask",
    "grep_app_*": "ask",
    "grep_app_searchGitHub": "allow"
  },
  {{ "// If no temperature is specified, OpenCode uses model-specific defaults," }}
  {{ "// typically 0 for most models, 0.55 for Qwen models" }}
  "agent": {{ include "dot_config/opencode/.agent.jsonc" | indent 2 | trim }},
  // "inputs": {{ $mcp.inputs | toJson | indent 2 | trim }},
  "mcp": {{ $mcpServers | toPrettyJson | indent 2 | trim }},
  // https://opencode.ai/docs/models/#recommended-models
  "provider": {
    {{- if and (eq .osIDLike "darwin") (eq .chezmoi.arch "arm64") }}
    // https://opencode.ai/docs/providers#llamacpp
    // FIXME: Unrecognized schema: {"description":"The call template for the UTCP Manual endpoint."}
    /* "llama.cpp": {
      "npm": "@ai-sdk/openai-compatible",
      "name": "llama-server (local)",
      "options": {
        "baseURL": "http://127.0.0.1:8080/v1",
      },
      "models": {
        // https://github.com/ggml-org/llama.cpp/discussions/15396
        // https://huggingface.co/ggml-org/gpt-oss-20b-GGUF
        // llama-server -hf ggml-org/gpt-oss-20b-GGUF --ctx-size 0 --jinja -ub 2048 -b 2048
        "ggml-org/gpt-oss-20b-GGUF": {
          "name": "gpt-oss-20b-GGUF",
          "limit": {
            "context": 128000,
            "output": 65536,
          },
        },
        "qwen3-coder:a3b": {
          "name": "Qwen3-Coder: a3b-30b (local)",
          "limit": {
            "context": 128000,
            "output": 65536,
          },
        },
      },
    }, */
    // FIXME: <|channel|>analysis<|message|>[...]
    // <|end|><|start|>assistant<|channel|>final<|message|>[...]
    "mlx-lm": {
      "npm": "@ai-sdk/openai-compatible",
      "name": "MLX LM (local)",
      "options": {
        "baseURL": "http://127.0.0.1:8080/v1"
      },
      "models": {
        "mlx-community/Llama-3.2-3B-Instruct-4bit": {
          "name": "mlx-community/Llama-3.2-3B-Instruct-4bit"
        },
        "mlx-community/gpt-oss-20b-mxfp4-q8": {
          "name": "mlx-community/gpt-oss-20b-mxfp4-q8"
        },
        "mlx-community/Qwen3-4B-Instruct-2507-4bit": {
          "name": "Qwen3-4B-Instruct-2507-4bit"
        },
        "mlx-community/Qwen3-30B-A3B-4bit": {
          "name": "mlx-community/Qwen3-30B-A3B-4bit"
        },
        "mlx-community/whisper-large-v3-mlx": {
          "name": "mlx-community/whisper-large-v3-mlx"
        },
        "mistralai/Mistral-7B-Instruct-v0.3": {
          "name": "Mistral-7B-Instruct-v0.3"
        },
        "lmstudio-community/Qwen3-Coder-30B-A3B-Instruct-MLX-4bit": {
          "name": "lmstudio-community/Qwen3-Coder-30B-A3B-Instruct-MLX-4bit"
        }
      }
    },
    // https://opencode.ai/docs/providers#ollama
    "ollama": {
      "npm": "@ai-sdk/openai-compatible",
      "name": "Ollama (local)",
      "options": {
        "baseURL": "http://127.0.0.1:11434/v1"
      },
      "models": {
        "deepseek-r1:8b": {
          "name": "deepseek-r1:8b"
        },
        "gpt-oss:20b": {
          "name": "gpt-oss:20b"
        },
        // If tool calls arenâ€™t working, try increasing num_ctx in Ollama
        // Start around 16k - 32k
        "llama2": {
          "name": "Llama 2"
        },
        "qwen3": {
          "name": "qwen3"
        },
        "qwen3:4b": {
          "name": "qwen3:4b"
        },
        "qwen3:8b": {
          "name": "qwen3:8b"
        },
        "qwen3:30b": {
          "name": "qwen3:30b"
        },
        "qwen3-coder:30b": {
          "name": "qwen3-coder:30b"
        }
      }
    },
    {{- end }}
    /* "openai": {
      "models": {
        "gpt-5": {
          "variants": {
            "high": {
              "reasoningEffort": "high",
              "textVerbosity": "low",
              "reasoningSummary": "auto",
            },
            "low": {
              "reasoningEffort": "low",
              "textVerbosity": "low",
              "reasoningSummary": "auto",
            },
          },
        },
      },
    },
    "anthropic": {
      "models": {
        "claude-sonnet-4-5-20250929": {
          "options": {
            "thinking": {
              "type": "enabled",
              "budgetTokens": 16000,
            },
          },
        },
      },
    }, */
    {{- $litellmURL := env "LITELLM_API_BASE" }}
    {{- $litellmKey := env "LITELLM_API_KEY" }}
    {{- if $litellmURL }}
    "litellm": {
      "npm": "@ai-sdk/openai-compatible",
      "name": "LiteLLM (custom)",
      "options": {
        "baseURL": {{ $litellmURL | quote }}
      },
      "models": {
        "github_copilot/*": {
          "name": "All"
        },
        // "github_copilot/claude-haiku-4.5": {
        //   "name": "Claude Haiku 4.5"
        // },
        // "github_copilot/claude-sonnet-4-5": {
        //   "name": "Claude Sonnet 4.5"
        // },
        // "github_copilot/claude-opus-4-5": {
        //   "name": "Claude Opus 4.5"
        // }
      }
    },
    {{- end }}
    "google": {
      "name": "Google",
      "models": {
        "antigravity-gemini-3-pro": {
          "name": "Gemini 3 Pro (Antigravity)",
          "limit": {
            "context": 1048576,
            "output": 65535
          },
          "modalities": {
            "input": [
              "text",
              "image",
              "pdf"
            ],
            "output": [
              "text"
            ]
          },
          "variants": {
            "low": {
              "thinkingLevel": "low"
            },
            "high": {
              "thinkingLevel": "high"
            }
          }
        },
        "antigravity-gemini-3-flash": {
          "name": "Gemini 3 Flash (Antigravity)",
          "limit": {
            "context": 1048576,
            "output": 65536
          },
          "modalities": {
            "input": [
              "text",
              "image",
              "pdf"
            ],
            "output": [
              "text"
            ]
          },
          "variants": {
            "minimal": {
              "thinkingLevel": "minimal"
            },
            "low": {
              "thinkingLevel": "low"
            },
            "medium": {
              "thinkingLevel": "medium"
            },
            "high": {
              "thinkingLevel": "high"
            }
          }
        },
        "antigravity-claude-sonnet-4-5": {
          "name": "Claude Sonnet 4.5 (Antigravity)",
          "limit": {
            "context": 200000,
            "output": 64000
          },
          "modalities": {
            "input": [
              "text",
              "image",
              "pdf"
            ],
            "output": [
              "text"
            ]
          }
        },
        "antigravity-claude-sonnet-4-5-thinking": {
          "name": "Claude Sonnet 4.5 Thinking (Antigravity)",
          "limit": {
            "context": 200000,
            "output": 64000
          },
          "modalities": {
            "input": [
              "text",
              "image",
              "pdf"
            ],
            "output": [
              "text"
            ]
          },
          "variants": {
            "low": {
              "thinkingConfig": {
                "thinkingBudget": 8192
              }
            },
            "max": {
              "thinkingConfig": {
                "thinkingBudget": 32768
              }
            }
          }
        },
        "antigravity-claude-opus-4-5-thinking": {
          "name": "Claude Opus 4.5 Thinking (Antigravity)",
          "limit": {
            "context": 200000,
            "output": 64000
          },
          "modalities": {
            "input": [
              "text",
              "image",
              "pdf"
            ],
            "output": [
              "text"
            ]
          },
          "variants": {
            "low": {
              "thinkingConfig": {
                "thinkingBudget": 8192
              }
            },
            "max": {
              "thinkingConfig": {
                "thinkingBudget": 32768
              }
            }
          }
        }
      }
    }
  }
}
