#!/bin/sh

# https://ghostty.org/docs/install/binary

set -eu

. "$CHEZMOI_WORKING_TREE/home/.chezmoitemplates/helpers.sh"

if ! command -v ghostty; then
  {{- if eq .osID "darwin" }}
  echo >&2 "Managed by homebrew"
  {{- else if eq .osID "debian" }}
  echo >&2 "Installing ghostty"
  # https://github.com/clayrisser/debian-ghostty/
  export DEBIAN_FRONTEND=noninteractive
  . /etc/os-release
  if [ "$VERSION_ID" -lt 13 ]; then
    version_path="$VERSION_CODENAME/Debian_$VERSION_ID"
    echo "deb http://download.opensuse.org/repositories/home:/clayrisser:/$version_path/ /" |
      cmd sudo tee "/etc/apt/sources.list.d/home:clayrisser:$VERSION_CODENAME.list"
    cmd curl -fsSL "https://download.opensuse.org/repositories/home:clayrisser:$version_path/Release.key" |
      cmd gpg --dearmor |
      cmd sudo tee "/etc/apt/trusted.gpg.d/home_clayrisser_$VERSION_CODENAME.gpg" >/dev/null
  else
    cmd curl -fsSL https://download.opensuse.org/repositories/home:clayrisser:sid/Debian_Unstable/Release.key |
      cmd gpg --dearmor |
      cmd sudo tee /etc/apt/keyrings/home_clayrisser_sid.gpg >/dev/null
    cmd sudo tee /etc/apt/sources.list.d/home:clayrisser:sid.sources >/dev/null <<EOF
Types: deb
URIs: http://download.opensuse.org/repositories/home:/clayrisser:/sid/Debian_Unstable/
Suites: /
Signed-By: /etc/apt/keyrings/home_clayrisser_sid.gpg
EOF
  fi

  cmd sudo apt-get update --quiet >/dev/null
  cmd sudo -E apt-get install --quiet --yes ghostty >/dev/null

  {{- else if eq .osID "ubuntu" }}
  # https://github.com/mkasberg/ghostty-ubuntu
  export DEBIAN_FRONTEND=noninteractive
  version="$(get_release mkasberg/ghostty-ubuntu)"
  SUFFIX="${version##*-}" # ppa2
  version="${version%-*}" # 1.1.3-0
  ARCH="$CHEZMOI_ARCH"
  . /etc/os-release
  URL="https://github.com/mkasberg/ghostty-ubuntu/releases/download/${version}-${SUFFIX}/ghostty_${version}.${SUFFIX}_${ARCH}_$VERSION_ID.deb"
  cmd curl -LSfs "$URL" -o "$TMPDIR/ghostty.deb"
  cmd sudo apt-get install --quiet --yes "$TMPDIR/ghostty.deb"
  {{- else if eq .osID "fedora" }}
  if command -v dnf >/dev/null; then
    cmd sudo dnf copr enable --assumeyes --quiet scottames/ghostty
    # cmd sudo dnf install --nogpgcheck --repofrompath 'terra,https://repos.fyralabs.com/terra$releasever' terra-release
    cmd sudo dnf install --assumeyes --quiet ghostty
  else
    cmd . /etc/os-release
    cmd curl -fsSL "https://copr.fedorainfracloud.org/coprs/scottames/ghostty/repo/fedora-${VERSION_ID}/scottames-ghostty-fedora-${VERSION_ID}.repo" | sudo tee /etc/yum.repos.d/_copr:copr.fedorainfracloud.org:scottames:ghostty.repo >/dev/null
    cmd rpm-ostree refresh-md
    cmd rpm-ostree install --allow-inactive --assumeyes --idempotent ghostty
  fi
  # . /etc/os-release
  # cmd curl -fsSL "https://copr.fedorainfracloud.org/coprs/scottames/ghostty/repo/fedora-${VERSION_ID}/scottames-ghostty-fedora-${VERSION_ID}.repo" | sudo tee /etc/yum.repos.d/_copr:copr.fedorainfracloud.org:scottames:ghostty.repo > /dev/null
  # cmd rpm-ostree refresh-md
  # cmd rpm-ostree install ghostty
  echo >&2 "Installed ghostty"
  {{- else }}
  echo >&2 "Unknown system"
  exit 1
  {{- end }}
else
  echo >&2 "Already installed"
  cmd ghostty --version | head -n1
fi

# FIXME: Ghostty 1.2.0 missing theme
# cmd ghostty +validate-config
