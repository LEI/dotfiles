{{- $ignore := list }}
{{- range $line := includeTemplate ".chezmoiignore" . | splitList "\n" }}
{{-   if or (eq $line "") (eq ($line | trunc 1) "#") }}
{{-     continue }}
{{-   end }}
{{-   $ignore = $ignore | append $line }}
{{- end }}

{{- $packageFiles := list }}
{{- range $path := glob (joinPath .chezmoi.sourceDir "**" ".packages.yaml") }}
{{-   $ignored := false }}
{{-   range $excluded := $ignore }}
{{-     $regex := $excluded
          | replaceAllRegex " #.*" ""
          | replaceAllRegex "\\." "\\."
          | replaceAllRegex "\\*\\*" "*"
          | replaceAllRegex "\\*" ".*" }}
{{-     $relative := trimPrefix (printf "%s/" $.chezmoi.sourceDir) $path
          | replaceAllRegex "dot_" "."
          | replaceAllRegex "\\w+_" "" }}
{{- /*     warnf "regex: %s" $regex -}}
{{-     warnf "file: %s" $relative */ -}}
{{-     if regexMatch $regex $relative }}
{{-       if $.chezmoi.config.verbose }}
{{-         warnf "ignored: %s" $relative -}}
{{-       end }}
{{-       $ignored = true }}
{{-       continue }}
{{-     end }}
{{-   end }}
{{-   if $ignored }}
{{-     continue }}
{{-   end }}
{{-   $packageFiles = $packageFiles | append $path }}
{{- end }}
{{- $_ := . | set "packageFiles" $packageFiles }}

{{- if ne .os "darwin" }}
{{- $packages := includeTemplate "get-packages.json.tmpl" (mergeOverwrite . (dict "packageType" .packageManager)) | fromJson }}
{{ .packageManager }}: {{ $packages | toJSON }}
{{- end }}

{{- if eq .osIDLike "arch" }}
{{- $aurPackages := includeTemplate "get-packages.json.tmpl" (mergeOverwrite . (dict "packageType" "aur")) | fromJson }}
aur: {{ $aurPackages | toJSON }}
{{- end }}

{{- if .features.brew }}
{{- $allBrewPackages := dict }}
{{- $brewPackages := includeTemplate "get-packages.json.tmpl" (mergeOverwrite . (dict "packageType" "brew")) | fromJson }}
{{- $allBrewPackages = merge $allBrewPackages $brewPackages }}
{{- $caskPackages := includeTemplate "get-packages.json.tmpl" (mergeOverwrite . (dict "packageType" "cask")) | fromJson }}
{{- $allBrewPackages = merge $allBrewPackages $caskPackages }}
{{- $masPackages := eq .os "darwin" | ternary
  (includeTemplate "get-packages.json.tmpl" (mergeOverwrite . (dict "packageType" "mas")))
  "{}" | fromJson }}
{{- $vscodePackages := includeTemplate "get-packages.json.tmpl" (mergeOverwrite . (dict "packageType" "vscode")) | fromJson }}

{{- $taps := dict }}
{{- range $name, $pkg := $allBrewPackages }}
{{-   if contains "/" $name }}
{{-     $_ := $taps | setValueAtPath ($name | replaceAllRegex "/[\\w@-]+$" "") dict }}
{{-   end }}
{{- end }}

{{- $brewfile := joinPath (env "XDG_CONFIG_HOME" | default (joinPath  .chezmoi.homeDir ".config")) "homebrew/Brewfile" -}}
{{- $lines := list }}
{{- if stat $brewfile -}}
{{-   $lines = include $brewfile | splitList "\n" }}
{{- end -}}
{{- range $lines | without "" }}
{{-   if eq (substr 0 1 .) "#" -}}
{{-     continue -}}
{{-   end -}}
{{-   $type := index (. | splitList " ") 0 }}
{{-   $pattern := printf "^%s \"(.*)\",? ?(.*)$" $type }}
{{-   $name := . | replaceAllRegex $pattern "${1}" }}
{{-   $options := . | replaceAllRegex $pattern "${2}" }}
{{-   if eq $type "tap" }}
{{-     if and ($taps | get $name) ($taps | get $name | get "options") -}}
{{-       warnf "Overriding %s options: %s (%s -> %s)" $type $name ($taps | get $name | get "options") $options -}}
{{-     end -}}
{{-     $_ := $taps | set $name (dict "options" $options) }}
{{-   else if eq $type "brew" }}
{{-     if and ($brewPackages | get $name) (($brewPackages | get $name) | get "options") -}}
{{-       warnf "Overriding %s options: %s (%s -> %s)" $type $name ($brewPackages | get $name | get "options") $options -}}
{{-     end -}}
{{-     $_ := $brewPackages | set $name (dict "options" $options) }}
{{-   else if eq $type "cask" }}
{{-     if and ($caskPackages | get $name) (($caskPackages | get $name) | get "options") -}}
{{-       warnf "Overriding %s options: %s (%s -> %s)" $type $name ($caskPackages | get $name | get "options") $options -}}
{{-     end -}}
{{-     $_ := $caskPackages | set $name (dict "options" $options) }}
{{-   else if eq $type "mas" }}
{{-     if and ($masPackages | get $name) ($masPackages | get $name | get "options") -}}
{{-       warnf "Overriding %s options: %s (%s -> %s)" $type $name ($masPackages | get $name | get "options") $options -}}
{{-     end -}}
{{-     $_ := $masPackages | set $name (dict "options" $options) }}
{{-   else if eq $type "vscode" }}
{{-     if and ($vscodePackages | get $name) ($vscodePackages | get $name | get "options") -}}
{{-       warnf "Overriding %s options: %s (%s -> %s)" $type $name ($vscodePackages | get $name | get "options") $options -}}
{{-     end -}}
{{-     $_ := $vscodePackages | set $name (dict "options" $options) }}
{{-   end }}
{{- end }}
tap: {{ $taps | toJSON }}
brew: {{ $brewPackages | toJSON }}
cask: {{ $caskPackages | toJSON }}
{{- if eq .os "darwin" }}
mas: {{ $masPackages | toJSON }}
{{- end }}
vscode: {{ $vscodePackages | toJSON }}

{{- end }}

{{- if eq .os "windows" }}
{{- $scoopPackages := includeTemplate "get-packages.json.tmpl" (mergeOverwrite . (dict "packageType" "scoop")) | fromJson }}
scoop: {{ $scoopPackages | toJSON }}
{{- end }}

{{- if and (eq .osIDLike "arch" "fedora") (lookPath "flatpak" | isExecutable) }}
{{- $flatpakPackages := includeTemplate "get-packages.json.tmpl" (mergeOverwrite . (dict "packageType" "flatpak")) | fromJson }}
flatpak: {{ $flatpakPackages | toJSON }}
{{- end }}

{{- if .features.mise }}
{{- $misePackages := includeTemplate "get-packages.json.tmpl" (mergeOverwrite . (dict "packageType" "mise")) | fromJson }}
mise: {{ $misePackages | toJSON }}
{{- end }}

{{- if .features.go }}
{{- $goPackages := includeTemplate "get-packages.json.tmpl" (mergeOverwrite . (dict "packageType" "go")) | fromJson }}
go: {{ $goPackages | toJSON }}
{{- end }}

{{- if .features.node }}
{{- $nodePackages := includeTemplate "get-packages.json.tmpl" (mergeOverwrite . (dict "packageType" "npm")) | fromJson }}
npm: {{ $nodePackages | toJSON }}
{{- end }}

{{- if .features.python }}
{{- $pipPackages := includeTemplate "get-packages.json.tmpl" (mergeOverwrite . (dict "packageType" "pip")) | fromJson }}
pip: {{ $pipPackages | toJSON }}
{{- $pipxPackages := includeTemplate "get-packages.json.tmpl" (mergeOverwrite . (dict "packageType" "pipx")) | fromJson }}
pipx: {{ $pipxPackages | toJSON }}
{{- $uvPackages := includeTemplate "get-packages.json.tmpl" (mergeOverwrite . (dict "packageType" "uv")) | fromJson }}
uv: {{ $uvPackages | toJSON }}
{{- end }}

{{- if .features.ruby }}
{{- $rubyGems := includeTemplate "get-packages.json.tmpl" (mergeOverwrite . (dict "packageType" "gem")) | fromJson }}
gem: {{ $rubyGems | toJSON }}
{{- end }}

{{- if .features.rust }}
{{- $cargoPackages := includeTemplate "get-packages.json.tmpl" (mergeOverwrite . (dict "packageType" "cargo")) | fromJson }}
cargo: {{ $cargoPackages | toJSON }}
{{- end }}
