#!/bin/sh

# NOTE: after install-packages.sh (system)

set -eu

. "$CHEZMOI_WORKING_TREE/home/.chezmoitemplates/helpers.sh"

# NOTE: not supported by pipx
if [ "${DRY_RUN:-}" = true ]; then
  set -- "$@" --dry-run
fi

pip_packages={{ .packages.pip | keys | sortAlpha | join " " | quote }}
if [ -n "$pip_packages" ]; then
  python=python
  if ! command -v python >/dev/null && command -v python3 >/dev/null; then
    python=python3
  fi
  run $python -m pip install --user --quiet "$@" $pip_packages
fi

pipx_packages={{ .packages.pipx | keys | sortAlpha | join " " | quote }}
if [ -n "$pipx_packages" ] && command -v pipx >/dev/null; then
  dry_run pipx install "$@" $pipx_packages
fi

# https://github.com/astral-sh/uv/issues/13750
# run uv tool install --quiet{{ if .upgrade }} --upgrade{{ end }} "$@" $uv_packages

{{- $uvPackages := .packages.uv }}

{{- if empty $uvPackages }}
{{-   warnf "missing uv packages" }}
{{- end }}

{{- if eq (env "CACHE_BUST") "true" }}
# uv hash: {{ output "sh" (joinPath .chezmoi.sourceDir "dot_local/bin/executable_list-package") "uv" | sha256sum }}
{{- end }}

{{- range $key, $value := $uvPackages }}
{{-   $command := get $value "command" | default $key
  | replaceAllRegex `\[.*\]$` ""
  | replaceAllRegex `-cli$` "" }}
{{-   if and (not $.upgrade) ((lookPath $command) | isExecutable) }}
echo >&2 "Already installed: {{ $key }}"
{{-     continue }}
{{-   end }}
run uv tool install --quiet{{ if $.upgrade }} --upgrade{{ end }} "$@" {{ $key }}
{{- end }}
