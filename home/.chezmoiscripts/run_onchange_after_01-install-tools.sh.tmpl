#!/bin/sh

set -eu

. "$CHEZMOI_WORKING_TREE/home/.chezmoitemplates/helpers.sh"

{{ includeTemplate "dot_config/sh/plugins/mise.sh.tmpl" . | trim }}

if [ "${DRY_RUN:-}" = true ]; then
  set -- "$@" --dry-run
fi
set -- "$@" --yes

{{- if .upgrade }}

# if ! run mise self-update "$@"; then
#   echo >&2 "mise self-update failed with exit code $?"
# fi
{{- end }}

# TODO: check gpg-agent is running

{{- $tools := get (includeTemplate "dot_config/mise/config.toml.tmpl" . | fromToml) "tools" }}

# config.toml tools hash: {{ $tools | toJson | sha256sum }}
echo >&2 "Installing tools"

# mise_args="--yes"
# if [ "${CHEZMOI_VERBOSE:-}" = 1 ]; then
#   mise_args="$mise_args --verbose"
# fi

run timeout 5m mise {{ if .upgrade }}upgrade{{ else }}install{{ end }} "$@"

echo >&2 "Installed tools"

# run mise ls "$@"

{{- $tools := list }}

{{- if get .packages.mise "go" }}
# default-go-packages: includeTemplate "dot_config/mise/default-go-packages.tmpl" . | sha256sum
{{- $tools = append $tools (printf "go@%s" (get .packages.mise.go "version" | default "latest")) }}
{{- end }}

{{- if get .packages.mise "node" }}
# default-npm-packages: includeTemplate "dot_config/mise/default-npm-packages.tmpl" . | sha256sum
{{- $tools = append $tools (printf "node@%s" (get .packages.mise.node "version" | default "latest")) }}
{{- end }}

{{- if get .packages.mise "python" }}
# default-python-packages: includeTemplate "dot_config/mise/default-python-packages.tmpl" . | sha256sum
{{- $tools = append $tools (printf "python@%s" (get .packages.mise.python "version" | default "latest")) }}
{{- end }}

{{- if get .packages.mise "ruby" }}
# default-gems: includeTemplate "dot_config/mise/default-gems.tmpl" . | sha256sum
{{- $tools = append $tools (printf "ruby@%s" (get .packages.mise.ruby "version" | default "latest")) }}
{{- end }}

{{- if not (empty $tools) }}

# FIXME: ensure new tools are installed and preserve order
# run mise unuse --global --no-prune "$@" {{ $tools | sortAlpha | join " " }}
# run mise use --global "$@" {{ $tools | sortAlpha | join " " }}
{{- end }}

# run mise prune "$@" # --tools
