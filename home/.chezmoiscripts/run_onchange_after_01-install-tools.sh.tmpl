#!/bin/sh

set -eu

. "$CHEZMOI_WORKING_TREE/home/.chezmoitemplates/helpers.sh"

{{ includeTemplate "dot_config/sh/plugins/mise.sh.tmpl" . | trim }}

if [ "${DRY_RUN:-}" = true ]; then
  set -- "$@" --dry-run
fi
set -- "$@" --yes

{{- if .upgrade }}

# if ! run mise self-update "$@"; then
#   echo >&2 "mise self-update failed with exit code $?"
# fi
{{- end }}

# TODO: check gpg-agent is running

{{- $tools := includeTemplate "dot_config/mise/config.toml.tmpl" . | fromToml | get "tools" }}

# config.toml tools hash: {{ $tools | toJSON | sha256Sum }}
echo >&2 "Installing tools"

# mise_args="--yes"
# if [ "${CHEZMOI_VERBOSE:-}" = 1 ]; then
#   mise_args="$mise_args --verbose"
# fi

run timeout 5m mise {{ if .upgrade }}upgrade{{ else }}install{{ end }} "$@"

echo >&2 "Installed tools"

# run mise ls "$@"

{{- /* $tools := list }}

{{- if .packages.mise | get "go" }}
# default-go-packages: includeTemplate "dot_config/mise/default-go-packages.tmpl" . | sha256Sum
{{- $tools = $tools | append "go" }}
{{- end }}

{{- if .packages.mise | get "node" }}
# default-npm-packages: includeTemplate "dot_config/mise/default-npm-packages.tmpl" . | sha256Sum
{{- $tools = $tools | append "node" }}
{{- end }}

{{- if .packages.mise | get "python" }}
# default-python-packages: includeTemplate "dot_config/mise/default-python-packages.tmpl" . | sha256Sum
{{- $tools = $tools | append "python" }}
{{- end }}

{{- if .packages.mise | get "ruby" }}
# default-gems: includeTemplate "dot_config/mise/default-gems.tmpl" . | sha256Sum
{{- $tools = $tools | append "ruby" }}
{{- end }}

{{- if not (empty $tools) }}

# FIXME: ensure new tools are installed and show hash diff
run mise use --global "$@" {{ $tools | sortAlpha | join " " }}
{{- end }}

# run mise prune "$@" # --tools
{{- */ -}}
