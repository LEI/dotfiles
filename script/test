#!/usr/bin/env bash
#MISE alias="t"
#MISE description="`mise test` or `mise run t`"

# https://github.com/shunk031/dotfiles/blob/master/scripts/run_unit_test.sh

set -euo pipefail

PATH="$PATH:$HOME/.local/bin"
if [ -x /home/linuxbrew/.linuxbrew/bin/brew ] && ! command -v brew >/dev/null; then
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi

main() {
  local jobs="${TEST_JOBS:-1}"
  if command -v parallel >/dev/null; then
    jobs="${TEST_JOBS:-$(nproc)}"
  fi
  if [ -n "${TERM:-}" ] && [ "$TERM" != dumb ]; then
    set -- --pretty "$@"
  fi
  # set -- --trace "$@"
  set -x
  bats \
    --jobs "$jobs" \
    --print-output-on-failure \
    --show-output-of-passing-tests \
    --timing \
    --recursive ./test "$@"
}

main "$@"
