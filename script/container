#!/usr/bin/env bash
#MISE description="mise container"

# PROFILE=minimal mise container alpine up --build --detach
# PROFILE=minimal mise container alpine exec -it alpine-latest-minimal bash -i

# https://www.chezmoi.io/reference/commands/docker/

set -euxo pipefail

# CHEZMOI_PROFILE="${CHEZMOI_PROFILE:-}" # minimal
# EPHEMERAL="${EPHEMERAL:-false}"
# HEADLESS="${HEADLESS:-false}"

# PREFIX="${PREFIX:-}" # termux prefix
PROVIDER="${PROVIDER:-podman}"

tag_prefix=chezmoi

if [ $# -eq 0 ]; then
  echo >&2 "Usage: container <name[:version]>"
  exit 1
fi

container_status() {
  $PROVIDER container inspect --format '{{.State.Status}}' "$@"
}

build_container() {
  name="$1"
  shift
  image_name="${name%:*}"
  if [[ "$name" = *:* ]]; then
    image_version="${name#*:}"
  else
    image_version=latest
  fi
  name="$tag_prefix-$image_name-$image_version"
  if [ "$image_name" = termux ]; then
    image_name_arg="docker.io/termux/termux-docker"
    image_version_arg="x86_64"
    # prefix=/data/data/com.termux/files/home
    # user=a0_test
    # TODO: prefix bootstrap only for termux in docker
  fi

  # case "$image_name" in
  # *) ;;
  # esac

  # container_user=test
  user="test"
  home="/home/$user"
  if [ "$image_name" = termux ]; then
    prefix=/data/data/com.termux/files
    home="$prefix/home"
    # container_user=root
    user=a0_test
  fi
  chezmoi_root="$home/.local/share/chezmoi"

  $PROVIDER build . \
    --build-arg=IMAGE_NAME="${image_name_arg:-$image_name}" \
    --build-arg=IMAGE_VERSION="${image_version_arg:-$image_version}" \
    --build-arg=USER="$user" \
    --tag="$name"

  # $PROVIDER run -it --name="$name" --rm "$name" "$@"
  # --userns=keep-id
  # --volume="$PWD:$chezmoi_root:ro"
  if ! $PROVIDER container inspect "$name" >/dev/null; then
    $PROVIDER create --name="$name" "$name" # "$@"
  fi
  if [ "$(container_status "$name")" != running ]; then
    $PROVIDER start "$name" # "$@"
  fi
  status="$(container_status "$name")"
  if [ "$status" != running ]; then
    echo >&2 "Container $name is not running (status: $status)"
    exit 1
  fi
  $PROVIDER exec "$name" mkdir -p "$chezmoi_root"
  $PROVIDER container cp .chezmoiroot "$name:$chezmoi_root/"
  $PROVIDER container cp .chezmoiversion "$name:$chezmoi_root/"
  $PROVIDER container cp --overwrite home "$name:$chezmoi_root/"
  $PROVIDER container cp script "$name:$chezmoi_root/"

  # FIXME: Cannot run 'pkg' command as root
  if [ "$image_name" = termux ]; then
    # ln -sf ${PREFIX}/etc/termux/mirrors/default ${PREFIX}/etc/termux/chosen_mirrors
    $PROVIDER exec "$name" sh -c 'set -x; pkg update --quiet && pkg install --quiet --yes chezmoi proot'
  fi

  # $PROVIDER exec "$name" ls -la "home"
  # $PROVIDER exec "$name" sudo chown -R test:test "$home/.local"
  $PROVIDER exec \
    --env=CI=true \
    --workdir="$chezmoi_root" \
    "$name" ./script/bootstrap --branch=main # --no-tty --verbose

  $PROVIDER exec --workdir="$chezmoi_root" "$name" ./script/check
  $PROVIDER exec --workdir="$chezmoi_root" "$name" ./script/update
  $PROVIDER container cp test "$name:$chezmoi_root/"
  if [ -d test_support ]; then
    $PROVIDER container cp test_support "$name:$chezmoi_root/"
  fi
  $PROVIDER exec --workdir="$chezmoi_root" "$name" ./script/test

  if [ $# -eq 0 ]; then
    set -- bash -i
  fi
  $PROVIDER exec \
    --interactive \
    --tty \
    --workdir="$chezmoi_root" \
    "$name" "$@"
}

name="$1"
shift

if [ "$name" = all ]; then
  images=(
    alpine
    archlinux
    debian
    ubuntu
    fedora
    # termux
  )
  for img in "${images[@]}"; do
    if ! time build_container "$img" "$@"; then
      exit $?
    fi
  done
  exit
fi

time build_container "$name" "$@"
