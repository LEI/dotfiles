#!/usr/bin/env bash
#MISE description="mise container"

# PROFILE=minimal mise container alpine up --build --detach
# PROFILE=minimal mise container alpine exec -it alpine-latest-minimal bash -i

# https://www.chezmoi.io/reference/commands/docker/

set -euxo pipefail

# CHEZMOI_PROFILE="${CHEZMOI_PROFILE:-}" # minimal
# EPHEMERAL="${EPHEMERAL:-false}"
# HEADLESS="${HEADLESS:-false}"

# PREFIX="${PREFIX:-}" # termux prefix
PROVIDER="${PROVIDER:-podman}"

tag_prefix=chezmoi

if [ $# -eq 0 ]; then
  echo >&2 "Usage: container <name[:version]>"
  exit 1
fi

build_container() {
  name="$1"
  shift
  image_name="${name%:*}"
  if [[ "$name" = *:* ]]; then
    image_version="${name#*:}"
  else
    image_version=latest
  fi
  tag="$tag_prefix-$image_name-$image_version"
  if [ "$image_name" = termux ]; then
    image_name="docker.io/termux/termux-docker"
    image_version="x86_64"
    # prefix=/data/data/com.termux/files/home
    # user=a0_test
  fi

  # case "$image_name" in
  # *) ;;
  # esac
  $PROVIDER build . \
    --build-arg=IMAGE_NAME="$image_name" \
    --build-arg=IMAGE_VERSION="$image_version" \
    --tag="$tag"
  if [ $# -gt 0 ]; then
    $PROVIDER run --name="$tag_prefix-$image_name-run" --rm "$tag" "$@"
  fi
}

name="$1"
shift

if [ "$name" = all ]; then
  images=(
    alpine
    archlinux
    debian
    ubuntu
    fedora
    termux
  )
  for img in "${images[@]}"; do
    time build_container "$img" "$@"
  done
  return
fi

time build_container "$name" "$@"
